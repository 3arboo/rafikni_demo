{% extends 'base.html' %}
{% load static %}

{% block title %}لوحة تحكم العميل - RaFiKNi{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>لوحة تحكم العميل</h2>
        <form method="post" action="{% url 'switch_role' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt me-2"></i> التبديل إلى مقدم خدمة
            </button>
        </form>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <img src="{% if user.profile.profile_image %}{{ user.profile.profile_image.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                         class="rounded-circle mb-3" width="120" height="120" alt="صورة الملف الشخصي">
                    <h5 class="mb-1">{{ user.full_name }}</h5>
                    <p class="text-muted mb-3">عميل</p>
                    <a href="{% url 'edit_profile' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i> تعديل الملف
                    </a>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-bars me-2"></i> القائمة
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action active">
                        <i class="fas fa-tachometer-alt me-2"></i> لوحة التحكم
                    </a>
                    <a href="{% url 'browse_services' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-concierge-bell me-2"></i> تصفح الخدمات
                    </a>
                    <a href="{% url 'my_bookings' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-calendar-check me-2"></i> حجوزاتي
                    </a>
                    <a href="{% url 'consultation_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-comments me-2"></i> استشاراتي
                    </a>
                    <a href="{% url 'document_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-file-contract me-2"></i> وثائقي
                    </a>
                    <a href="{% url 'notifications' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-bell me-2"></i> الإشعارات
                    </a>
                    <a href="{% url 'faq_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-question-circle me-2"></i> الأسئلة الشائعة
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white text-center py-3">
                        <div class="card-body">
                            <h3 class="mb-0">{{ active_consultations }}</h3>
                            <p class="mb-0">استشارات نشطة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white text-center py-3">
                        <div class="card-body">
                            <h3 class="mb-0">{{ active_bookings }}</h3>
                            <p class="mb-0">حجوزات نشطة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white text-center py-3">
                        <div class="card-body">
                            <h3 class="mb-0">{{ documents_count }}</h3>
                            <p class="mb-0">وثائق محفوظة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white text-center py-3">
                        <div class="card-body">
                            <h3 class="mb-0">{{ unread_notifications }}</h3>
                            <p class="mb-0">إشعارات جديدة</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم الحجوزات -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">حجوزاتي القادمة</h5>
                    <div>
                        <a href="{% url 'my_bookings' %}" class="btn btn-sm btn-outline-primary me-2">
                            عرض الكل <i class="fas fa-arrow-left"></i>
                        </a>
                        <a href="{% url 'browse_services' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i> حجز جديد
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if upcoming_bookings %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>الخدمة</th>
                                    <th>مقدم الخدمة</th>
                                    <th>التاريخ</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in upcoming_bookings %}
                                <tr>
                                    <td>
                                        <a href="{% url 'service_detail' booking.service.slug %}">{{ booking.service.title }}</a>
                                    </td>
                                    <td>
                                        <a href="{% url 'consultant_detail' booking.service.provider.consultant.id %}">
                                            {{ booking.service.provider.full_name }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if booking.slot %}
                                            {{ booking.slot.start_time|date:"d/m/Y - H:i" }}
                                        {% else %}
                                            غير محدد
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if booking.status == 'confirmed' %}success
                                            {% elif booking.status == 'pending' %}warning
                                            {% elif booking.status == 'cancelled' %}danger
                                            {% else %}secondary{% endif %}">
                                            {{ booking.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'booking_detail' booking.id %}" class="btn btn-outline-primary" title="التفاصيل">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if booking.status == 'pending' or booking.status == 'confirmed' %}
                                            <a href="{% url 'cancel_booking' booking.id %}" class="btn btn-outline-danger" title="إلغاء الحجز">
                                                <i class="fas fa-times"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center py-3">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="mb-0">لا توجد حجوزات قادمة</p>
                        <a href="{% url 'browse_services' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-plus me-1"></i> احجز خدمة الآن
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- قسم الاستشارات -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">استشاراتي القادمة</h5>
                    <a href="{% url 'consultation_list' %}" class="btn btn-sm btn-outline-primary">
                        عرض الكل <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% if upcoming_consultations %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>الخدمة</th>
                                    <th>مقدم الخدمة</th>
                                    <th>التاريخ</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for consultation in upcoming_consultations %}
                                <tr>
                                    <td>{{ consultation.service.title }}</td>
                                    <td>{{ consultation.slot.provider.username }}</td>
                                    <td>{{ consultation.slot.start_time|date:"d/m/Y - H:i" }}</td>
                                    <td>
                                        <span class="badge bg-{% if consultation.status == 'confirmed' %}success{% else %}warning{% endif %}">
                                            {{ consultation.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'consultation_detail' consultation.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center py-3">
                        <i class="fas fa-calendar-check fa-2x mb-2"></i>
                        <p class="mb-0">لا توجد استشارات قادمة</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- قسم الوثائق -->
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">وثائقي المهمة</h5>
                    <a href="{% url 'document_list' %}" class="btn btn-sm btn-outline-primary">
                        عرض الكل <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% if important_documents %}
                    <div class="list-group">
                        {% for doc in important_documents %}
                        <a href="{% url 'document_list' %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ doc.title }}</h6>
                                {% if doc.reminder_date %}
                                <small class="text-{% if doc.is_urgent %}danger{% else %}success{% endif %}">
                                    {{ doc.reminder_days }} أيام متبقية
                                </small>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                تاريخ التذكير: {{ doc.reminder_date|date:"d/m/Y" }}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center py-3">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <p class="mb-0">لا توجد وثائق مهمة</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
